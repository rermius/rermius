name: Release Linux

on:
  push:
    branches: [build, test, build-only, release-linux]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag (e.g., v1.2.3 or 1.2.3)'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    environment: build
    permissions:
      contents: write
    if: ${{ !contains(github.event.head_commit.message, '[skip build]') && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[skip linux]') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag and version
        id: tag-version
        run: |
          # Get tag
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
            if [ "${TAG#v}" = "$TAG" ]; then
              TAG="v$TAG"
            fi
          else
            TAG=$(git describe --exact-match --tags HEAD 2>/dev/null || echo "")
          fi

          # Get version (remove 'v' prefix)
          if [ -n "$TAG" ]; then
            VERSION="${TAG#v}"
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Using tag: $TAG, version: $VERSION"
          else
            echo "tag=" >> $GITHUB_OUTPUT
            echo "version=" >> $GITHUB_OUTPUT
            echo "No tag found. Skipping upload."
          fi

      - name: Update version files
        if: steps.tag-version.outputs.version != ''
        run: |
          node scripts/update-version.js "${{ steps.tag-version.outputs.version }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Build Tauri app
        run: npm run tauri build -- --target x86_64-unknown-linux-gnu

      - name: Upload Linux artifacts
        if: steps.tag-version.outputs.tag != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag-version.outputs.tag }}
          files: |
            src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage/*.AppImage
            src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/deb/*.deb
            src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/rpm/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
